{% extends 'base.html' %}
{% load widget_tweaks %}


{% block title %}Edit Profile - Peer Organ{% endblock %}


{% block css_section %}
    <style>
        /* üé® Custom styles for enhanced form UX */
        
        /* Smooth focus transitions */
        input, select, textarea {
            transition: all 0.2s ease-in-out;
        }
        
        /* Custom select arrow */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        /* Dark mode select arrow */
        .dark select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        
        /* Loading animation for submit button */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Profile strength meter */
        .strength-meter {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        }
        
        /* Custom scrollbar for form */
        .form-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .form-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .form-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .dark .form-scroll::-webkit-scrollbar-track {
            background: #374151;
        }
        
        .dark .form-scroll::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
    </style>
{% endblock css_section %}


{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- üéØ Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Edit Your Profile</h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
            Update your personal information and preferences to improve matching accuracy.
        </p>
    </div>

    <!-- üì± Progress Steps (Desktop) -->
    <div class="hidden md:block mb-8">
        <div class="flex items-center justify-between">
            <!-- Step 1: Basic Info -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 
                            {% if activeTab == 'basic' %}bg-primary-500 text-white{% else %}bg-gray-200 text-gray-500{% endif %} 
                            rounded-full">
                    1
                </div>
                <span class="ml-2 text-sm font-medium 
                            {% if activeTab == 'basic' %}text-primary-600{% else %}text-gray-500{% endif %}">
                    Basic Info
                </span>
            </div>

            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            
            <!-- Step 2: Medical Details -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 
                            {% if activeTab == 'medical' %}bg-primary-500 text-white{% else %}bg-gray-200 text-gray-500{% endif %} 
                            rounded-full">
                    2
                </div>
                <span class="ml-2 text-sm font-medium 
                            {% if activeTab == 'medical' %}text-primary-600{% else %}text-gray-500{% endif %}">
                    Medical Details
                </span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            
            <!-- Step 3: Preferences -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-200 text-gray-500 rounded-full">
                    3
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Preferences</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            
            <!-- Step 4: Location -->
            <div class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-200 text-gray-500 rounded-full">
                    4
                </div>
                <span class="ml-2 text-sm font-medium text-gray-500">Location</span>
            </div>
        </div>
    </div>


    <!-- üìù Edit Profile Form -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
        <form method="post" 
              x-data="{ activeTab: 'basic' }"
              class="divide-y divide-gray-200 dark:divide-gray-700">
            {% csrf_token %}
            
            <!-- üîí Form Errors Display -->
            {% if form.errors %}
            <div class="p-6 bg-red-50 dark:bg-red-900/20 border-b border-red-200 dark:border-red-800">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-red-400 text-lg">‚ö†Ô∏è</span>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800 dark:text-red-400">
                            Please correct the errors below
                        </h3>
                        <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                            <ul class="list-disc list-inside space-y-1">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- üìã Basic Information Tab -->
            <div x-show="activeTab === 'basic'" x-transition>
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <span class="bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 p-2 rounded-lg mr-3">
                            üë§
                        </span>
                        Basic Information
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Username Field -->
                        <div>
                            <label for="{{ form.username.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Username *
                            </label>
                            {% render_field form.username class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="Enter your username" %}
                            {% if form.username.help_text %}
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{{ form.username.help_text }}</p>
                            {% endif %}
                        </div>

                        <!-- Email Field -->
                        <div>
                            <label for="{{ form.email.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Email Address *
                            </label>
                            {% render_field form.email class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="your@email.com" %}
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label for="{{ form.phone_number.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Phone Number
                            </label>
                            {% render_field form.phone_number class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="+1 (555) 123-4567" %}
                        </div>

                        <!-- Blood Type -->
                        <div>
                            <label for="{{ form.blood_type.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Blood Type *
                            </label>
                            {% render_field form.blood_type class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" %}
                        </div>

                        <!-- Date of Birth -->
                        <div>
                            <label for="{{ form.date_of_birth.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Date of Birth
                            </label>
                            {% render_field form.date_of_birth type="date" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- üè† Location Information Tab -->
            <div x-show="activeTab === 'location'" x-transition>
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
                        <span class="bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 p-2 rounded-lg mr-3">
                            üìç
                        </span>
                        Location Information
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- City -->
                        <div>
                            <label for="{{ form.city.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                City *
                            </label>
                            {% render_field form.city class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="Enter your city" %}
                        </div>

                        <!-- State -->
                        <div>
                            <label for="{{ form.state.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                State *
                            </label>
                            {% render_field form.state class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="Enter your state" %}
                        </div>

                        <!-- ZIP Code -->
                        <div>
                            <label for="{{ form.zip_code.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                ZIP Code
                            </label>
                            {% render_field form.zip_code class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="12345" %}
                        </div>

                        <!-- Location -->
                        <div>
                            <label for="{{ form.location.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Full Address
                            </label>
                            {% render_field form.location class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:text-white transition-colors" placeholder="Your complete address" rows="3" %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- üéØ Form Actions -->
            <div class="p-6 bg-gray-50 dark:bg-gray-900/50">
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                    <!-- Tab Navigation (Mobile) -->
                    <div class="md:hidden flex space-x-2">
                        <button type="button" 
                                @click="activeTab = 'basic'"
                                :class="activeTab === 'basic' ? 'bg-primary-500 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Basic
                        </button>
                        <button type="button" 
                                @click="activeTab = 'medical'"
                                :class="activeTab === 'medical' ? 'bg-primary-500 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Medical
                        </button>
                        <button type="button" 
                                @click="activeTab = 'preferences'"
                                :class="activeTab === 'preferences' ? 'bg-primary-500 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Prefs
                        </button>
                        <button type="button" 
                                @click="activeTab = 'location'"
                                :class="activeTab === 'location' ? 'bg-primary-500 text-white' : 'bg-gray-200 text-gray-700'"
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Location
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex space-x-3">
                        <a href="{% url 'profiles:profile_dashboard' %}" 
                           class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium">
                            Cancel
                        </a>
                        <button type="submit"
                                class="px-6 py-3 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors font-medium flex items-center">
                            <span>Update Profile</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- üí° Profile Completion Tips -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Tip Card 1 -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div class="flex items-start">
                <span class="text-blue-500 text-lg mr-3">üí°</span>
                <div>
                    <h4 class="font-medium text-blue-900 dark:text-blue-100">Complete Your Profile</h4>
                    <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">
                        Profiles with complete information get 3x more matches.
                    </p>
                </div>
            </div>
        </div>

        <!-- Tip Card 2 -->
        <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
            <div class="flex items-start">
                <span class="text-green-500 text-lg mr-3">üîí</span>
                <div>
                    <h4 class="font-medium text-green-900 dark:text-green-100">Privacy Protected</h4>
                    <p class="text-sm text-green-700 dark:text-green-300 mt-1">
                        Your personal information is secure and only shared with matches.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // üì± Mobile-friendly form enhancements
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-format phone number
        const phoneInput = document.querySelector('input[name="phone_number"]');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            });
        }

        // Real-time validation feedback
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() !== '') {
                    this.classList.add('border-green-300', 'dark:border-green-600');
                    this.classList.remove('border-red-300', 'dark:border-red-600');
                } else if (this.required) {
                    this.classList.add('border-red-300', 'dark:border-red-600');
                    this.classList.remove('border-green-300', 'dark:border-green-600');
                }
            });

            input.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    this.classList.add('border-green-300', 'dark:border-green-600');
                    this.classList.remove('border-red-300', 'dark:border-red-600');
                }
            });
        });

        // Auto-save draft functionality (using HTMX)
        let saveTimer;
        const form = document.querySelector('form');
        form.addEventListener('input', function() {
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                // Show saving indicator
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span>Saving...</span><svg class="w-4 h-4 ml-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2"></path></svg>';
                
                // Simulate auto-save (in real app, this would be an HTMX call)
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                }, 1000);
            }, 2000); // Save after 2 seconds of inactivity
        });

        // Character counters for text fields
        const textAreas = document.querySelectorAll('textarea');
        textAreas.forEach(textarea => {
            const counter = document.createElement('div');
            counter.className = 'text-xs text-gray-500 dark:text-gray-400 mt-1 text-right';
            textarea.parentNode.appendChild(counter);
            
            textarea.addEventListener('input', function() {
                const maxLength = this.getAttribute('maxlength') || 500;
                const currentLength = this.value.length;
                counter.textContent = `${currentLength}/${maxLength} characters`;
                
                if (currentLength > maxLength * 0.8) {
                    counter.classList.add('text-yellow-600');
                    counter.classList.remove('text-gray-500');
                } else {
                    counter.classList.remove('text-yellow-600');
                    counter.classList.add('text-gray-500');
                }
            });
            
            // Trigger initial count
            textarea.dispatchEvent(new Event('input'));
        });
    });

    // üéØ Alpine.js functionality for enhanced UX
    document.addEventListener('alpine:init', () => {
        Alpine.data('editProfile', () => ({
            // Profile strength calculator
            profileStrength: 0,
            
            calculateStrength() {
                const fields = document.querySelectorAll('input[required], select[required], textarea[required]');
                let filled = 0;
                
                fields.forEach(field => {
                    if (field.value.trim() !== '') filled++;
                });
                
                this.profileStrength = Math.round((filled / fields.length) * 100);
                return this.profileStrength;
            },
            
            // Tab management
            activeTab: 'basic',
            
            setTab(tabName) {
                this.activeTab = tabName;
                // Update URL hash for deep linking
                window.location.hash = tabName;
            },
            
            init() {
                // Check URL hash for tab deep linking
                if (window.location.hash) {
                    this.activeTab = window.location.hash.replace('#', '');
                }
                
                // Calculate initial profile strength
                this.calculateStrength();
                
                // Recalculate on input changes
                document.querySelector('form').addEventListener('input', () => {
                    this.calculateStrength();
                });
            }
        }));
    });
</script>
{% endblock %}